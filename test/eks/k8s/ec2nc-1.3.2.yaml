apiVersion: karpenter.k8s.aws/v1
kind: EC2NodeClass
metadata:
  name: default-ec2nc
spec:
  ${yamlencode({
  subnetSelectorTerms: [for subnet_id in subnet_ids : {id: "${subnet_id}"}]
  })}
  securityGroupSelectorTerms:
    - id: ${security_group_id}
  instanceProfile: ${iam_instance_profile}
  amiSelectorTerms:
    - alias: ${ami_alias}
  metadataOptions:
    httpEndpoint: ${metadata_options.http_endpoint}
    httpProtocolIPv6: disabled
    httpPutResponseHopLimit: 1 # This is changed to disable IMDS access from containers not on the host network
    httpTokens: required

  # Optional, configures storage devices for the instance
  blockDeviceMappings:
    - deviceName: /dev/xvda
      ebs:
        volumeSize: 100Gi
        volumeType: gp3
        iops: 10000
        encrypted: true
        kmsKeyID: "1234abcd-12ab-34cd-56ef-1234567890ab"
        deleteOnTermination: true
        throughput: 125
        snapshotID: snap-0123456789

  # Optional, use instance-store volumes for node ephemeral-storage
  instanceStorePolicy: RAID0

  # Optional, overrides autogenerated userdata with a merge semantic
  userData: |
    echo "Hello world"    
  detailedMonitoring: true